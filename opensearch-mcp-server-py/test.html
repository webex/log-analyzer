<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webex Calling Microservices Flow</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #0f4c75;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #3282b8;
            padding-bottom: 10px;
        }
        h2 {
            color: #0f4c75;
            margin-top: 40px;
            margin-bottom: 20px;
            border-left: 4px solid #3282b8;
            padding-left: 15px;
        }
        .diagram-container {
            margin: 30px 0;
            padding: 20px;
            background: #fafafa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        .phase-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #1976d2;
        }
        .phase-info h3 {
            color: #1976d2;
            margin-top: 0;
        }
        .key-points {
            background: #f1f8e9;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #4caf50;
        }
        .key-points ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .service-legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .service-card {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid;
            text-align: center;
        }
        .mobius { border-color: #4a148c; background: #f3e5f5; }
        .realtime { border-color: #1b5e20; background: #e8f5e8; }
        .external { border-color: #e65100; background: #fff3e0; }
        .user { border-color: #01579b; background: #e1f5fe; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Webex Calling Microservices Flow</h1>
        
        <div class="phase-info">
            <h3>Overview</h3>
            <p>This diagram shows the complete interaction flow between Webex microservices when making a call, from initial setup through call termination. The flow involves 41 distinct steps across 8 phases.</p>
        </div>

        <h2>ğŸ”„ Complete Call Flow (41 Steps)</h2>
        <div class="diagram-container">
            <div class="mermaid">
graph TD
    %% User and Client Layer
    User[ğŸ‘¤ User] 
    Client[ğŸ’» Webex Client<br/>Desktop/Web/Mobile]
    
    %% Load Balancer
    LB[âš–ï¸ Load Balancer]
    
    %% Core Webex Services
    subgraph "Mobius Services"
        MobReg[ğŸ“‹ Mobius Registration<br/>mobiusreg]
        MobCall[ğŸ“ Mobius Call App<br/>mobiuscall] 
        MobSIP[ğŸ“¡ Mobius SIP App<br/>mobiussip]
    end
    
    subgraph "Real-time Services"
        Apheleia[ğŸ‘¥ Apheleia<br/>Presence Service]
        Mercury[âš¡ Mercury<br/>Message Service]
        MercConn[ğŸ”— Mercury Connection<br/>Partitions 0,1,2]
    end
    
    %% External Services
    subgraph "External Infrastructure"
        WDM[ğŸ”§ WDM<br/>Device Management]
        RTMS[ğŸ“ RTMS<br/>SIP Infrastructure]
        Teams[ğŸ’¼ MS Teams<br/>Presence Sync]
    end
    
    %% Other Users/Contacts
    Contacts[ğŸ‘¥ User Contacts<br/>Supervisors]
    CallParticipant[ğŸ‘¤ Call Participant]

    %% PHASE 1: PRE-CALL SETUP
    User -.->|"1. Login/Available"| Client
    Client -->|"2. Register Device"| LB
    LB --> MobReg
    MobReg -->|"3. Device Registration"| WDM
    MobReg -->|"4. SIP Registration"| RTMS
    
    %% Presence Setup
    Client -->|"5. Set Available Status"| Apheleia
    Apheleia -->|"6. Sync Presence"| Teams
    Apheleia -->|"7. Publish Status"| Mercury
    Mercury -->|"8. Notify Contacts"| Contacts

    %% PHASE 2: CALL INITIATION
    User -.->|"9. Initiate Call"| Client
    Client -->|"10. Call Request"| MobCall
    MobCall -->|"11. Check Availability"| Apheleia
    Apheleia -->|"12. User Available"| MobCall
    
    %% PHASE 3: STATUS UPDATE
    MobCall -->|"13. Update Status<br/>workStatus: call<br/>availability: busy"| Apheleia
    Apheleia -->|"14. Broadcast Status"| Mercury
    Mercury -->|"15. User now 'On Call'"| Contacts
    Mercury -->|"16. Sync to Teams"| Teams

    %% PHASE 4: SIP CALL SETUP
    MobCall -->|"17. Create SIP Call"| MobSIP
    MobSIP -->|"18. SIP INVITE"| RTMS
    RTMS -->|"19. Route to Participant"| CallParticipant
    CallParticipant -->|"20. SIP Response"| RTMS
    RTMS -->|"21. Call Progress"| MobSIP
    MobSIP -->|"22. Call State Updates"| MobCall

    %% PHASE 5: MEDIA NEGOTIATION
    MobCall -->|"23. ROAP Offer<br/>Media Capabilities"| Mercury
    Mercury -->|"24. Route to Participant"| MercConn
    MercConn -->|"25. Real-time Delivery"| CallParticipant
    CallParticipant -->|"26. ROAP Answer"| MercConn
    MercConn -->|"27. Media Response"| Mercury
    Mercury -->|"28. Complete Setup"| MobCall

    %% PHASE 6: ACTIVE CALL
    MobCall -.->|"29. Call Active"| User
    User -.->|"30. Media Actions<br/>(mute, video, share)"| Client
    Client -->|"31. ROAP Updates"| MobCall
    MobCall -->|"32. Real-time Events"| Mercury
    Mercury -->|"33. Live Updates"| CallParticipant

    %% PHASE 7: CALL END
    User -.->|"34. End Call"| Client
    Client -->|"35. Disconnect"| MobCall
    MobCall -->|"36. SIP BYE"| MobSIP
    MobSIP -->|"37. Terminate SIP"| RTMS
    
    %% PHASE 8: CLEANUP
    MobCall -->|"38. Reset Status<br/>workStatus: null<br/>availability: available"| Apheleia
    Apheleia -->|"39. User Available"| Mercury
    Mercury -->|"40. Status Update"| Contacts
    Mercury -->|"41. Sync Available"| Teams

    %% Styling
    classDef userStyle fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef mobiusStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:2px  
    classDef realtimeStyle fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef externalStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px
    
    class User,Client,Contacts,CallParticipant userStyle
    class MobReg,MobCall,MobSIP mobiusStyle
    class Apheleia,Mercury,MercConn realtimeStyle
    class WDM,RTMS,Teams externalStyle
            </div>
        </div>

        <div class="service-legend">
            <div class="service-card user">
                <h4>ğŸ‘¤ User Layer</h4>
                <p>Users, Clients, Contacts</p>
            </div>
            <div class="service-card mobius">
                <h4>ğŸ“ Mobius Services</h4>
                <p>Registration, Call, SIP</p>
            </div>
            <div class="service-card realtime">
                <h4>âš¡ Real-time Services</h4>
                <p>Apheleia, Mercury</p>
            </div>
            <div class="service-card external">
                <h4>ğŸ”§ External Systems</h4>
                <p>WDM, RTMS, Teams</p>
            </div>
        </div>

        <h2>ğŸ” Data Flow & Correlation IDs</h2>
        <div class="diagram-container">
            <div class="mermaid">
graph LR
    subgraph "Correlation IDs"
        TrackingID[ğŸ” WEBEX_TRACKINGID<br/>End-to-end tracing]
        CallID[ğŸ“ mobiusCallId<br/>Call session]
        SipID[ğŸ“¡ sipCallId<br/>SIP protocol]
        DeviceID[ğŸ“± deviceId<br/>User endpoint]
    end
    
    subgraph "Service Data"
        RegData[ğŸ“‹ Registration Entity<br/>â€¢ userId, deviceId<br/>â€¢ sipAddress<br/>â€¢ orgId, serviceIndicator]
        PresenceData[ğŸ‘¥ Presence Composition<br/>â€¢ availability<br/>â€¢ workStatus<br/>â€¢ lastActivity]
        CallData[ğŸ“ Call Context<br/>â€¢ legType, callState<br/>â€¢ offerAnswerContext<br/>â€¢ eventLog]
        MediaData[âš¡ ROAP Messages<br/>â€¢ messageType OFFER/ANSWER<br/>â€¢ SDP media capabilities<br/>â€¢ sequence numbers]
    end
    
    TrackingID -.-> RegData
    TrackingID -.-> PresenceData  
    TrackingID -.-> CallData
    TrackingID -.-> MediaData
    
    CallID -.-> CallData
    CallID -.-> MediaData
    SipID -.-> CallData
    DeviceID -.-> RegData
    DeviceID -.-> PresenceData
            </div>
        </div>

        <h2>ğŸ“Š Call State Machine</h2>
        <div class="diagram-container">
            <div class="mermaid">
stateDiagram-v2
    [*] --> UserAvailable : User logs in
    
    UserAvailable --> CallInitiated : User starts call
    CallInitiated --> CheckingAvailability : Mobius queries Apheleia
    CheckingAvailability --> UpdatingStatus : User confirmed available
    UpdatingStatus --> SIPSetup : Status set to busy/on call
    
    SIPSetup --> MediaNegotiation : SIP INVITE successful
    MediaNegotiation --> CallActive : ROAP exchange complete
    
    CallActive --> MediaUpdates : User actions mute/video/share
    MediaUpdates --> CallActive : Real-time ROAP updates
    
    CallActive --> CallEnding : User hangs up
    CallEnding --> Cleanup : SIP BYE sent
    Cleanup --> UserAvailable : Status reset to available
    
    UserAvailable --> [*] : User logs out
            </div>
        </div>

        <h2>ğŸŒ Geographic Distribution</h2>
        <div class="diagram-container">
            <div class="mermaid">
graph TB
    subgraph "Americas - Chicago ACHM"
        ACHM_Mobius[ğŸ¢ Mobius Services<br/>acmhwxt-prd-1]
        ACHM_Mercury[âš¡ Mercury<br/>prod-achm-mercury1/2]
        ACHM_Apheleia[ğŸ‘¥ Apheleia<br/>prod-achm-general1/2]
    end
    
    subgraph "Americas - Oregon AORE" 
        AORE_Mercury[âš¡ Mercury<br/>prod-aore-mercury2]
        AORE_Apheleia[ğŸ‘¥ Apheleia<br/>prod-aore-general1/2]
    end
    
    subgraph "APAC - Sydney ASYD"
        ASYD_Mobius[ğŸ¢ Mobius Services<br/>asydwxt-prd-3]
    end
    
    subgraph "APAC - Singapore ASIN"
        ASIN_Mobius[ğŸ¢ Mobius Services<br/>asinwxt-prd-3]
    end
    
    subgraph "EMEA - London WLHR"
        WLHR_Mobius[ğŸ¢ Mobius Services<br/>wlhrwxc-p-1]
    end
    
    User_US[ğŸ‘¤ US User] --> ACHM_Mobius
    User_APAC[ğŸ‘¤ APAC User] --> ASYD_Mobius
    User_EMEA[ğŸ‘¤ EMEA User] --> WLHR_Mobius
    
    ACHM_Mobius <-.-> ACHM_Mercury
    ACHM_Mobius <-.-> ACHM_Apheleia
    
    ACHM_Mercury <-.->|Cross-region sync| AORE_Mercury
    ACHM_Apheleia <-.->|Global presence| AORE_Apheleia
            </div>
        </div>

        <h2>ğŸ“‹ Phase Breakdown</h2>
        
        <div class="phase-info">
            <h3>ğŸ”¹ Phase 1-2: Setup & Initiation (Steps 1-12)</h3>
            <ul>
                <li>User authentication and device registration with WDM</li>
                <li>SIP registration with RTMS infrastructure</li>
                <li>Presence status establishment via Apheleia</li>
                <li>Call request routing through load balancer</li>
            </ul>
        </div>

        <div class="phase-info">
            <h3>ğŸ”¹ Phase 3-4: Status & SIP Setup (Steps 13-22)</h3>
            <ul>
                <li>Status update to "busy/on call" via Apheleia</li>
                <li>SIP protocol establishment through RTMS</li>
                <li>Contact notification via Mercury broadcasting</li>
                <li>Call state machine initialization</li>
            </ul>
        </div>

        <div class="phase-info">
            <h3>ğŸ”¹ Phase 5-6: Media & Active Call (Steps 23-33)</h3>
            <ul>
                <li>ROAP media negotiation via Mercury</li>
                <li>Real-time call experience establishment</li>
                <li>Live media updates (mute, video, screen share)</li>
                <li>Continuous event streaming</li>
            </ul>
        </div>

        <div class="phase-info">
            <h3>ğŸ”¹ Phase 7-8: Termination & Cleanup (Steps 34-41)</h3>
            <ul>
                <li>Call disconnection via SIP BYE</li>
                <li>Status reset to "available" in Apheleia</li>
                <li>Final contact notifications via Mercury</li>
                <li>Resource cleanup and state reset</li>
            </ul>
        </div>

        <div class="key-points">
            <h3>ğŸ¯ Key Service Interactions</h3>
            <ul>
                <li><strong>Mobius â†” Apheleia:</strong> Availability checking and status updates</li>
                <li><strong>Mobius â†” Mercury:</strong> Real-time event delivery (ROAP messages)</li>
                <li><strong>Apheleia â†” Mercury:</strong> Presence broadcasting to contacts</li>
                <li><strong>All Services â†” External:</strong> WDM, RTMS, MS Teams integration</li>
            </ul>
        </div>

        <div class="key-points">
            <h3>ğŸ“¡ Real-time Data Flows</h3>
            <ul>
                <li><strong>ROAP Messages:</strong> Media capabilities, offers, answers</li>
                <li><strong>Presence Updates:</strong> Status changes broadcast to contacts</li>
                <li><strong>Call Events:</strong> State changes, media updates, user actions</li>
                <li><strong>Cross-platform Sync:</strong> Teams, supervisor dashboards</li>
            </ul>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                htmlLabels: true,
                curve: 'basis'
            },
            themeVariables: {
                fontFamily: 'Segoe UI, sans-serif',
                fontSize: '14px',
                primaryColor: '#e1f5fe',
                primaryTextColor: '#01579b',
                primaryBorderColor: '#01579b',
                lineColor: '#666',
                sectionBkgColor: '#f0f8ff',
                altSectionBkgColor: '#e8f4f8',
                gridColor: '#ddd',
                secondaryColor: '#f3e5f5',
                tertiaryColor: '#e8f5e8'
            }
        });
    </script>
</body>
</html>
